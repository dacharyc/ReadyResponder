services:

  ruby:
    image: tugboatqa/debian
    default: true
    depends: database
    commands:
      init:
        - apt-get update
        - apt-get install ruby ruby-dev
        - apt-get install postgresql-client imagemagick zlib1g-dev libpq-dev libmagickwand-dev
        - gem update --system
        - gem install bundler:1.16.6
        - gem install rake:12.3.1
        - bundle install

      update:
        - bin/rails db:setup

      #build:
        # Set up a long-running process to run the rails server
        #- mkdir -p /etc/service/ruby
        #- echo "#!/bin/sh" > /etc/service/ruby/run
        #- echo "bin/rails s -b 0.0.0.0 -p 80" >> /etc/service/ruby/run
        #- chmod +x /etc/service/ruby/run

      start:
        - bin/rails s -b 0.0.0.0 -p 80

  database:
    image: tugboatqa/postgres:10.13
    commands:
      init:
        - psql -U postgres -d tugboat -c "ALTER USER tugboat WITH CREATEDB;"
      online:
        - psql -U postgres -d tugboat -c "ALTER USER tugboat WITH NOCREATEDB;"
